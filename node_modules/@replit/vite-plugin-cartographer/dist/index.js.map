{"version":3,"sources":["/Users/darsh/github/repl-it-web/pkg/vite-plugin-cartographer/dist/index.js","../src/cartographer.ts","../src/constants.ts","../package.json"],"names":[],"mappings":"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","file":"/Users/darsh/github/repl-it-web/pkg/vite-plugin-cartographer/dist/index.js","sourcesContent":[null,"import fs from 'fs/promises';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport { parse } from '@babel/parser';\nimport type {\n  File as BabelFile,\n  Node as BabelNode,\n  JSXIdentifier,\n  JSXMemberExpression,\n  JSXOpeningElement,\n} from '@babel/types';\nimport MagicString from 'magic-string';\nimport type { Plugin } from 'vite';\n\nimport {\n  DATA_ATTRIBUTES,\n  R3F_BAILOUT_ELEMENTS,\n  R3F_BAILOUT_PATTERNS,\n  R3F_IMPORT_SOURCES,\n} from './constants';\n\nconst validExtensions = new Set(['.jsx', '.tsx']);\n\nexport function cartographer(): Plugin {\n  let clientScript: string;\n  let configuredRoot: string;\n  let configuredRootName: string;\n\n  return {\n    name: '@replit/vite-plugin-cartographer',\n    enforce: 'pre' as const,\n\n    async configResolved(config) {\n      configuredRoot = config.root;\n      // The name of the directory that contains the configured root\n      configuredRootName = path.basename(configuredRoot);\n\n      // Resolve the client script path in both CJS and ESM environments\n      const currentFileUrl =\n        typeof __dirname === 'string'\n          ? path.join(__dirname, '../dist/beacon/index.global.js')\n          : fileURLToPath(\n              new URL('../dist/beacon/index.global.js', import.meta.url),\n            );\n\n      try {\n        clientScript = await fs.readFile(currentFileUrl, 'utf-8');\n      } catch (error) {\n        // eslint-disable-next-line no-console -- This is an error in the plugin\n        console.error(\n          '[replit-cartographer] Failed to load client script:',\n          error,\n        );\n      }\n    },\n\n    resolveId(_source, _importer) {\n      // Let Vite handle the resolution\n      return null;\n    },\n\n    transform: {\n      order: 'pre',\n      async handler(code: string, id: string) {\n        if (\n          !validExtensions.has(path.extname(id)) ||\n          id.includes('node_modules')\n        ) {\n          return null;\n        }\n\n        try {\n          const ast = parse(code, {\n            sourceType: 'module',\n            plugins: ['jsx', 'typescript'],\n          });\n\n          let isR3FFile = usesReactThreeFiber(ast);\n\n          if (isR3FFile) {\n            return null;\n          }\n\n          const magicString = new MagicString(code);\n          let currentElement: BabelNode | null = null;\n\n          // One day the JS ecosystem will decide on one standard to use, until then\n          // We need to dynamically import this so that we don't mess with vite resolving this module\n          // Handle CommonJS/ESM interop: @babel/traverse may be wrapped differently depending on the module system\n          const traverseModule = await import('@babel/traverse');\n          const traverse =\n            (\n              traverseModule.default as {\n                default?: typeof traverseModule.default;\n              }\n            )?.default ||\n            traverseModule.default ||\n            traverseModule;\n\n          if (typeof traverse !== 'function') {\n            // eslint-disable-next-line no-console -- I want my errors to be logged :D\n            console.error(\n              `[replit-cartographer] @babel/traverse did not resolve to a function.`,\n            );\n\n            return null; // Skip transformation instead of crashing\n          }\n\n          traverse(ast, {\n            JSXElement: {\n              enter(elementPath) {\n                if (isR3FFile) {\n                  return; // Optimization: Stop processing if we already know it's R3F\n                }\n\n                currentElement = elementPath.node;\n              },\n              exit() {\n                currentElement = null;\n              },\n            },\n            JSXOpeningElement(elementPath) {\n              if (isR3FFile) {\n                return;\n              }\n\n              const jsxNode = elementPath.node;\n              const elementName = getElementName(jsxNode);\n\n              if (!elementName) {\n                return;\n              }\n\n              // Check if this file contains R3F elements that should trigger a file-level bailout\n              if (shouldBailout(elementName)) {\n                isR3FFile = true;\n                elementPath.stop(); // Stop traversing this file entirely\n\n                return;\n              }\n\n              // Skip instrumentation for specific ambiguous elements (like 'line')\n              // We don't instrument them, but they don't trigger a file-level bailout\n              if (elementName === 'line') {\n                return;\n              }\n\n              if (currentElement) {\n                const { line = 0, column: col = 0 } = jsxNode.loc?.start ?? {};\n\n                const relativeToConfigured = path.relative(configuredRoot, id);\n                const componentPath = path.join(\n                  configuredRootName,\n                  relativeToConfigured,\n                );\n\n                const componentMetadata =\n                  col === 0\n                    ? `${componentPath}:${line}`\n                    : `${componentPath}:${line}:${col}`;\n\n                magicString.appendLeft(\n                  jsxNode.name.end ?? 0,\n                  ` ${DATA_ATTRIBUTES.METADATA}=\"${componentMetadata}\" ${DATA_ATTRIBUTES.COMPONENT_NAME}=\"${elementName}\"`,\n                );\n              }\n            },\n          });\n\n          if (isR3FFile) {\n            return null;\n          }\n\n          return {\n            code: magicString.toString(),\n            map: magicString.generateMap({ hires: true }),\n          };\n        } catch (error) {\n          // eslint-disable-next-line no-console -- I want my errors to be logged :D\n          console.error(`[replit-cartographer] Error processing ${id}:`, error);\n\n          return null;\n        }\n      },\n    },\n\n    transformIndexHtml() {\n      if (!clientScript) {\n        return [];\n      }\n\n      return [\n        {\n          tag: 'script',\n          attrs: { type: 'module' },\n          children: clientScript,\n          injectTo: 'head',\n        },\n      ];\n    },\n  };\n}\n\n// Helper function to extract element name from JSX node\nfunction getElementName(jsxNode: JSXOpeningElement): string | null {\n  if (jsxNode.name.type === 'JSXIdentifier') {\n    return jsxNode.name.name;\n  }\n\n  if (jsxNode.name.type === 'JSXMemberExpression') {\n    const memberExpr = jsxNode.name as JSXMemberExpression;\n    const object = memberExpr.object as JSXIdentifier;\n    const property = memberExpr.property as JSXIdentifier;\n\n    return `${object.name}.${property.name}`;\n  }\n\n  return null;\n}\n\nfunction usesReactThreeFiber(ast: BabelFile): boolean {\n  return ast.program.body.some(\n    (node) =>\n      node.type === 'ImportDeclaration' &&\n      typeof node.source.value === 'string' &&\n      R3F_IMPORT_SOURCES.has(node.source.value),\n  );\n}\n\nfunction shouldBailout(name: string): boolean {\n  if (R3F_BAILOUT_ELEMENTS.has(name)) {\n    return true;\n  }\n\n  return R3F_BAILOUT_PATTERNS.some((pattern) => name.match(pattern));\n}\n","export const DATA_ATTRIBUTES = {\n  METADATA: 'data-replit-metadata',\n  COMPONENT_NAME: 'data-component-name',\n} as const;\n\nexport const R3F_IMPORT_SOURCES = new Set([\n  '@react-three/fiber',\n  '@react-three/drei',\n  'react-three-fiber',\n]);\n\n// Elements that, if present, indicate the file is likely an R3F scene\nexport const R3F_BAILOUT_ELEMENTS = new Set([\n  'Canvas', // Top-level R3F component\n  'mesh',\n  'group',\n  'scene',\n  'primitive',\n  'points',\n  'instancedMesh',\n  'fog',\n  'fogExp2',\n  'object3D',\n]);\n\n// Regex patterns for elements that indicate R3F (e.g. <boxGeometry>, <ambientLight>)\nexport const R3F_BAILOUT_PATTERNS = [\n  /Geometry$/,\n  /Material$/,\n  /Light$/,\n  /Camera$/,\n  /Helper$/,\n  /Control$/,\n];\n","{\n  \"name\": \"@replit/vite-plugin-cartographer\",\n  \"version\": \"0.4.4\",\n  \"private\": false,\n  \"devDependencies\": {\n    \"@replit/tsconfig\": \"workspace:*\",\n    \"@types/babel__core\": \"^7.20.5\",\n    \"@types/babel__traverse\": \"^7.20.6\",\n    \"@types/node\": \"^22.5.5\",\n    \"@typescript-eslint/eslint-plugin\": \"^6.7.0\",\n    \"@typescript-eslint/parser\": \"^6.7.0\",\n    \"happy-dom\": \"^20.0.2\",\n    \"tsup\": \"^8.3.5\",\n    \"tsx\": \"^4.9.5\",\n    \"vite\": \"^5.4.10\",\n    \"vitest\": \"^3.2.4\"\n  },\n  \"main\": \"./src/index.ts\",\n  \"files\": [\n    \"src\"\n  ],\n  \"scripts\": {\n    \"build\": \"tsup\",\n    \"lint\": \"eslint src\",\n    \"format\": \"prettier --write \\\"src/**/*.ts\\\"\",\n    \"test\": \"vitest\"\n  },\n  \"dependencies\": {\n    \"@babel/parser\": \"^7.26.9\",\n    \"@babel/traverse\": \"^7.26.9\",\n    \"@babel/types\": \"^7.26.9\",\n    \"magic-string\": \"^0.30.12\",\n    \"modern-screenshot\": \"^4.6.0\"\n  }\n}\n"]}